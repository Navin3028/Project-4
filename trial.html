import json
import boto3
from botocore.exceptions import NoCredentialsError
import csv
import io
import datetime

s3 = boto3.client('s3')

BUCKET_NAME= 'finops-consolidated-reports'
def lambda_handler(event, context):
    print(event)
    method = event['httpMethod']
    
    # Serve HTML & JavaScript when method is GET
    if method == 'GET':
        selected_month = datetime.datetime.now().strftime('%B %Y')
        file_name = f"Consolidate report {selected_month}.csv"
        file_path = f"Consolidate Reports/2024/{file_name}"
        print('selected_month', selected_month)
        try:
            response = s3.get_object(Bucket=BUCKET_NAME, Key=file_path)
            csv_data = response['Body'].read().decode('ISO-8859-1')
            csv_reader = csv.DictReader(csv_data.splitlines())
            data = [row for row in csv_reader]

        except Exception as e:
            return {
                'statusCode': 500,
                'body': json.dumps({'error': f'Error retrieving CSV file from S3: {str(e)}'})
            }
        return serve_html_page(data)

    # Handle POST requests to fetch data based on selected month
    elif method == 'POST':
        body = json.loads(event['body'])
        selected_month = body['selectedMonth']
        file_name = f"Consolidate report {selected_month}.csv"
        file_path = f"Consolidate Reports/2024/{file_name}"
        print('post selected month', selected_month)
        # return fetch_month_data(selected_month)

# def fetch_month_data(selected_month):
        try:
            response = s3.get_object(Bucket=BUCKET_NAME, Key=file_path)
            csv_data = response['Body'].read().decode('ISO-8859-1')
            csv_reader = csv.DictReader(csv_data.splitlines())
            new_data = [row for row in csv_reader]
    
            return {
                'statusCode': 200,
                'body': json.dumps({
                    'tableData': new_data  # This will be a list of lists (table rows and cells)
                }),
                'headers': {
                    'Content-Type': 'application/json',
                }
            }
        except Exception as e:
            return {
                'statusCode': 500,
                'body': json.dumps({'error': str(e)})
            }

# # Fetch file from S3
# def fetch_file_from_s3(file_path):
#     try:
#         response = s3.get_object(Bucket=BUCKET_NAME, Key=file_path)
#         content = response['Body'].read().decode('utf-8')
#         return content
#     except NoCredentialsError:
#         raise Exception('Credentials not available')
#     except Exception as e:
#         raise Exception(f"Error fetching file from S3: {str(e)}")

# # Parse CSV data into a list of lists
# def parse_csv_data(csv_content):
#     csv_reader = csv.reader(io.StringIO(csv_content))
#     table_data = []
#     for row in csv_reader:
#         table_data.append(row)
#     return table_data

# Helper function to get the last 10 months (including current month)
def get_last_10_months():
    months = []
    date = datetime.datetime.now()

    for i in range(10):
        month_name = (date - datetime.timedelta(days=30 * i)).strftime("%B %Y")
        months.append(month_name)
    
    return months
    
def serve_html_page(data):
    # Dynamically generate the last 10 months
    months = get_last_10_months()
    print(months)
    html_content = """
<!DOCTYPE html>
<html>
<head>
    <title>Finops detail </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.4.7/crossfilter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://www.visionet.com/sites/default/files/vsi-favicon.png" />
    <style>
        
    </style>
</head>
<body>
    <div id="loader" class="d-none">
        <div class="spinner-border finopsLoader" role="status">
          <span class="sr-only">Loading...</span>
        </div>
    </div>
    
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 p-0">
                <div id="tabs" class="tabs">
                    <button class="tablink active" onclick="openTab(event, 'tab1')">Detail sheet</button>
                    <button class="tablink" onclick="openTab(event, 'tab2', 'https://gichuixvy7.execute-api.ap-south-1.amazonaws.com/finops_bu_stage/finops_bu-resource')">By BU Sheet</button>
                    <button class="tablink" onclick="openTab(event, 'tab3', 'https://yn2bvd6q9i.execute-api.ap-south-1.amazonaws.com/finops_stagee/finops_resource')">By Cloud Subscription sheet</button>
                    <button class="tablink" onclick="openTab(event, 'tab4', 'https://11285snxba.execute-api.ap-south-1.amazonaws.com/summary/summary')">Monthly Summary sheet</button>
                    <button class="tablink" onclick="openTab(event, 'tab5', 'https://47s8dpq4k2.execute-api.ap-south-1.amazonaws.com/variance/variance')">Monthly Variance sheet</button>
                    <button class="tablink" onclick="openTab(event, 'tab6','https://ylevq7chd5.execute-api.ap-south-1.amazonaws.com/allocation/allocation')">Allocation sheet</button>
                </div>
                
                <div id="tab1" class="tabcontent">
                    <button class="clearAllFilters" disabled><i class="bi bi-x-circle-fill" style="margin-right: 4px;"></i>Clear All Filters</button>
                    <button class="downloadReportBtn" onclick="downloadExcel()">Download Report</button>
                    <span class="monthDropdownOption">
                      <label for="monthDropdown">Select Month: </label>
                        <select id="monthDropdown" onchange="submitMonth()" style="border-radius: 4px; cursor: pointer;">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </span>
                    <table id="dataTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                    
                    <div id="noResultMsg" class="noResultMsg"></div>
                </div>

                <div id="tab2" class="tabcontent" style="display:none;">
                <iframe id="iframe2"></iframe>
                </div>
                  
                <div id="tab3" class="tabcontent" style="display:none;">
                    <iframe id="iframe3"></iframe>
                </div>
                
                <div id="tab4" class="tabcontent" style="display:none;">
                    <iframe id="iframe4"></iframe>
                </div>
                
                <div id="tab5" class="tabcontent" style="display:none;">
                    <iframe id="iframe5"></iframe>
                </div>
                
                <div id="tab6" class="tabcontent" style="display:none;">
                    <iframe id="iframe6"></iframe>
                </div>
                
            </div>
        </div>
    </div>

    <script>
     const monthDropdown = document.getElementById('monthDropdown');
      const months = """ + json.dumps(months) + """;
               
        months.forEach(month => {{
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month;
                    monthDropdown.appendChild(option);
        }});
        
        document.addEventListener('DOMContentLoaded', function() {
            const loader = document.getElementById("loader");
            loader.classList.remove("d-none");
    
            // Fetch initial data and hide loader after data is fetched
            fetchMonthData(document.getElementById('monthDropdown').value);
        });
        
        
        function submitMonth() {
            
        }
        
         function fetchMonthData(selectedMonth) {
            
            }
            
        
        // Show the loader
        function showLoader() {
           
        }
        
        // Hide the loader
        function hideLoader() {
           
        }
        
        function openTab(evt, tabName, url) {

    }
    
        document.getElementById("tab1").style.display = "block";
        document.getElementsByClassName("tablink")[0].className += " active";
    
                
        var data = """ + json.dumps(data) + """;
        var filters = {};
        buildTable();
        calculateGrandTotal();
        
         document.addEventListener('click', function(event) {
            var filterOptions = document.querySelectorAll('.filter-options');
            filterOptions.forEach(function(filterOptionsDiv) {
                var th = filterOptionsDiv.closest('th');
                if (!filterOptionsDiv.contains(event.target) && !th.contains(event.target)) {
                    filterOptionsDiv.style.display = 'none';
                }
            });
        });
        
        function enableClearAllButton() {

        }

        function disableClearAllButton() {

        }

        document.querySelector('.clearAllFilters').addEventListener('click', function() {

        });


        function buildTable() {
            var table = document.getElementById('dataTable');
            var thead = table.querySelector('thead');
            thead.innerHTML = '';
            var headerRow = thead.insertRow(0);
    
    Object.keys(data[0]).forEach(function (header) {
        var th = document.createElement('th');
        th.classList.add('table-heading');
        th.textContent = header.trim();
        th.style.cursor = 'pointer';

        if (header.trim() === 'Cost') {
            var brElement = document.createElement('br');
            th.appendChild(brElement);
            
            // Create sort options for the Cost column
            var sortDropdown = document.createElement('select');
            sortDropdown.classList.add('sort-dropdown');
            sortDropdown.innerHTML = `
                <option value="">Sort By</option>
                <option value="asc">Smallest to Largest</option>
                <option value="desc">Largest to Smallest</option>
                <option value="greater_than">Greater than</option>
            `;
            sortDropdown.addEventListener('click', function(event) {
                event.stopPropagation();
            });
            sortDropdown.addEventListener('change', function () {
                event.stopPropagation();
                var sortOrder = this.value;
                sortTable(header.trim(), sortOrder, th);
            });
            th.appendChild(sortDropdown);
        }

        var filterDiv = document.createElement('div');
        filterDiv.classList.add('filter');
        
        var label = document.createElement('label');
        label.innerHTML = '<i class="bi bi-funnel" style="font-size:14px"></i>'; // Down arrow symbol
        th.addEventListener('click', function () {
            event.stopPropagation();
            var filterOptions = document.querySelectorAll('.filter-options');
            filterOptions.forEach(function(filterOptionsDiv) {
                if (filterOptionsDiv !== filterDiv.querySelector('.filter-options')) {
                    filterOptionsDiv.style.display = 'none';
                }
            });

            var filterOptionsDiv = filterDiv.querySelector('.filter-options');
            filterOptionsDiv.style.display = filterOptionsDiv.style.display === 'block' ? 'none' : 'block';
        });
        
        filterDiv.appendChild(label);
        
        var filterOptionsDiv = document.createElement('div');
        filterOptionsDiv.classList.add('filter-options');
        
        var searchBox = document.createElement('input');
        searchBox.type = 'text';
        searchBox.placeholder = 'Search...';
        searchBox.addEventListener('input', function () {
            applySearchFilter(header.trim(), searchBox.value);
        });
        filterOptionsDiv.appendChild(searchBox);
        filterOptionsDiv.addEventListener('click', function(event) {
            event.stopPropagation();
        });
        filterDiv.appendChild(filterOptionsDiv);
        th.appendChild(filterDiv);
        headerRow.appendChild(th);
        buildFilter(header.trim(), filterOptionsDiv);
    });

    updateTable();
}

var originalData = [];

function sortTable(column, order, th) {
    event.stopPropagation();
    if (originalData && originalData.length === 0) {
        originalData = data.slice(); // Clone the original data
    }
    var existingInput = document.querySelector('.threshold-input');
    if (existingInput) {
        existingInput.remove();
    }
    if (order === 'greater_than') {
        var originalData = [...data];
        var thresholdInput = document.createElement('input');
        thresholdInput.type = 'number';
        thresholdInput.classList.add('threshold-input');
        thresholdInput.placeholder = 'Enter Value';
        thresholdInput.addEventListener('click', function(event) {
            event.stopPropagation();
        });
        thresholdInput.addEventListener('input', function () {
            event.stopPropagation();
            var threshold = parseFloat(thresholdInput.value);

            // Handle case for NaN or empty input
            if (isNaN(threshold) || thresholdInput.value === '') {
                data = originalData.slice();
            } else {
                data = originalData.filter(function (row) {
                    var value = parseFloat(row[column]);
                    console.log('Value in row:', value);
                    return !isNaN(value) && value > threshold;
                });
            }

            // Update the table after filtering or resetting
            updateTable();
        });           
        th.appendChild(thresholdInput);
    } else {
        data.sort(function (a, b) {
            var valueA = parseFloat(a[column]);
            var valueB = parseFloat(b[column]);

            if (isNaN(valueA)) return 0;
            if (isNaN(valueB)) return 0;

            if (order === 'asc') {
                return valueA - valueB;
            } else if (order === 'desc') {
                return valueB - valueA;
            }
            return 0;
        });
         updateTable();
    }
}


        function buildFilter(column, filterOptionsDiv) {
            var cf = crossfilter(data);
            var dimension = cf.dimension(function (d) { return d[column]; });
            var group = dimension.group();
            var all = group.all();
            filterOptionsDiv.innerHTML = ''; // Clear existing filter options
            var searchBox = document.createElement('input');
            searchBox.type = 'text';
            searchBox.placeholder = 'Search...';
            searchBox.addEventListener('input', function () {
                applySearchFilter(column, searchBox.value);
            });
            filterOptionsDiv.appendChild(searchBox);

            var selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.id = 'selectAll-' + column;
            selectAllCheckbox.addEventListener('change', function () {
                var checkboxes = filterOptionsDiv.querySelectorAll('input[type="checkbox"]:not(#selectAll-' + column + ')');
                checkboxes.forEach(function (checkbox) {
                    checkbox.checked = selectAllCheckbox.checked;
                    applyFilter(column, checkbox.value, selectAllCheckbox.checked);
                });
            });
            var selectAllLabel = document.createElement('label');
            selectAllLabel.textContent = 'All';
            var selectAllDiv = document.createElement('div');
            selectAllDiv.appendChild(selectAllCheckbox);
            selectAllDiv.appendChild(selectAllLabel);
            filterOptionsDiv.appendChild(selectAllDiv);

            all.forEach(function (d) {
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = d.key;
                checkbox.checked = filters[column] && filters[column].includes(d.key);
                checkbox.addEventListener('change', function () {
                    applyFilter(column, checkbox.value, checkbox.checked);
                });
                var label = document.createElement('label');
                label.textContent = d.key;
                var div = document.createElement('div');
                div.appendChild(checkbox);
                div.appendChild(label);
                filterOptionsDiv.appendChild(div);
            });

            var clearButton = document.createElement('button');
            clearButton.textContent = 'Clear';
            clearButton.classList.add('btn', 'btn-danger', 'clear-button');
            clearButton.addEventListener('click', function () {
                delete filters[column];
                updateFilters();
                updateTable();
                buildFilter(column, filterOptionsDiv);
            });
            filterOptionsDiv.appendChild(clearButton);
        }

        function applyFilter(column, value, checked) {
            if (!filters[column]) {
                filters[column] = [];
            }
            if (checked) {
                filters[column].push(value);
                enableClearAllButton();
            } else {
                filters[column] = filters[column].filter(function (v) { return v !== value; });
                if (filters[column].length === 0) {
                    delete filters[column];
                }
            }
            updateFilters();
            updateTable();
            
        }

function updateFilters() {
    if (originalData && originalData.length === 0) {
        originalData = data.slice();
    }
     var filteredData = originalData;
    for (var column in filters) {
        if (filters.hasOwnProperty(column) && filters[column].length > 0) {
            filteredData = filteredData.filter(function (row) {
                return filters[column].includes(row[column]);
            });
        }
    }
    data = filteredData;
    enableClearAllButton();
    buildTable(Object.keys(data[0] || {}));
}
 

        function applySearchFilter(column, query) {
            var filterOptionsDiv = document.querySelectorAll('.filter-options');
            filterOptionsDiv.forEach(function (filterDiv) {
                filterDiv.querySelectorAll('div').forEach(function (div) {
                    if (div.textContent.toLowerCase().includes(query.toLowerCase())) {
                        div.style.display = '';
                    } else {
                        div.style.display = 'none';
                    }
                });
            });
            updateFilters();
            updateTable();
        }

        function applyFilters(row) {
            for (var column in filters) {
                if (filters.hasOwnProperty(column) && filters[column].length > 0) {
                    if (!filters[column].includes(row[column])) {
                        return false;
                    }
                }
            }
            return true;
        }
        

        function updateTable() {
            var table = document.getElementById('dataTable');
            var tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            data.forEach(function (row) {
                if (applyFilters(row)) {
                    var tr = tbody.insertRow();
                    for (var key in row) {
                        if (row.hasOwnProperty(key)) {
                            var td = tr.insertCell();
                            if (key === 'Cost') {
                                var value = parseFloat(row[key]);
                                if (Math.abs(value) < 0.00001) {  // Example threshold for exponential format
                                    td.textContent = '$' + value.toExponential(); // Use exponential format for very small values
                                } else {
                                    td.textContent = '$' + value.toLocaleString('en-IN'); // Default formatting for other values
                                }
                            } else {
                                td.textContent = row[key];
                            }
                        }
                    }
                }
            });
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            var sum = 0;
            var table = document.getElementById('dataTable');
            var visibleRows = Array.from(table.querySelectorAll('tbody tr'));
            visibleRows.forEach(function (row) {
                var costCell = row.cells[Object.keys(data[0]).indexOf('Cost')];
                if (costCell) {
                    var costValue = parseFloat(costCell.textContent.replace(/[$,]/g, '')) || 0;
                    sum += costValue;
                }
            });
            var existingGrandTotalRow = table.querySelector('.grand-total');
            if (existingGrandTotalRow) {
                existingGrandTotalRow.remove();
            }
         
            var tFoot = table.createTFoot();
            var grandTotalRow = tFoot.insertRow();
            grandTotalRow.className = 'grand-total';
            var grandTotalCell = grandTotalRow.insertCell();
            grandTotalCell.colSpan = Object.keys(data[0]).length - 1;
            grandTotalCell.textContent = 'Grand Total';
            grandTotalCell.classList.add('grandTotal');
            var grandTotalCostCell = grandTotalRow.insertCell();
            grandTotalCostCell.classList.add('table-heading')
            grandTotalCostCell.textContent = '$' + sum.toLocaleString('en-IN', { maximumFractionDigits: 2 });
        }
        
        
async function downloadExcel() {
    try {
        // Create a new ExcelJS workbook
        const workbook = new ExcelJS.Workbook();

        // List of tab names and corresponding element IDs for the tables
        const tabs = [
            { name: 'Detail Sheet', id: 'dataTableDetail' },  // Assuming 'dataTableDetail' is the table ID for Detail Sheet
            { name: 'BU Sheet', id: 'dataTableBU' }           // Assuming 'dataTableBU' is the table ID for BU Sheet
        ];

        for (const tab of tabs) {
            // Get the table element
            const tableElement = document.getElementById(tab.id);

            if (!tableElement) {
                console.error(`Table with ID ${tab.id} not found!`);
                continue;
            }

            // Add a new worksheet for the current tab
            const worksheet = workbook.addWorksheet(tab.name);

            // Loop through each row of the table
            for (let rowIndex = 0; rowIndex < tableElement.rows.length; rowIndex++) {
                const row = tableElement.rows[rowIndex];
                const rowData = Array.from(row.cells).map(cell => cell.textContent.trim());

                // Add row to Excel worksheet
                worksheet.addRow(rowData);
            }

            // Autofit column widths for each worksheet
            worksheet.columns.forEach(column => {
                let maxLength = 0;
                column.eachCell({ includeEmpty: true }, (cell) => {
                    const cellLength = cell.value ? cell.value.toString().length : 10;
                    if (cellLength > maxLength) maxLength = cellLength;
                });
                column.width = maxLength + 2;
            });
        }

        // Trigger the download of the Excel workbook
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'consolidated_report.xlsx');

    } catch (error) {
        console.error("Error creating Excel file:", error);
    }
}





        
    </script>
</body>
</html>
    """

    return {
        'statusCode': 200,
        'headers': {
            'Content-Type': 'text/html',
        },
        'body': html_content
    }
